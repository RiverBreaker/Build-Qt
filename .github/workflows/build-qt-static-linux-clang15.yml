name: Build Qt6 -static for Linux (Clang15)

on:
  workflow_dispatch:
    inputs:
      qt_majmin:
        description: 'Qt ‰∏ªÁâàÊú¨Âè∑‰∏éÊ¨°ÁâàÊú¨Âè∑(>=6.7.0)'
        required: true
        default: '6.9'
      qt_patch:
        description: 'Qt Ë°•‰∏ÅÁâàÊú¨Âè∑(‰æãÂ¶Ç 0)'
        required: false
        default: '0'

jobs:
  build-qt:
    name: Build Qt ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }} for Linux(Clang15)
    runs-on: ubuntu-latest    
    permissions:
      contents: write

    env:
      QT_MAJMIN: ${{ inputs.qt_majmin }}
      QT_VERSION: ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}
      TAG: v${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}-static
      GITHUB_REPOSITORY: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      QT_SOURCE_URL: https://download.qt.io/archive/qt/${{ inputs.qt_majmin }}/${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}/single/qt-everywhere-src-${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}.tar.xz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          architecture: 'x64'

      - name: Cache Qt source
        id: cache-qt-source
        uses: actions/cache@v3
        with:
          key: qt-src-${{ env.QT_VERSION }}-Unix
          path: ${{ runner.temp }}/qt6_src

      - name: install build-tools-package for Linux-Clang15
        id: install_build_tools
        run: |
          sudo apt-get update

          # ÂÆâË£Ö Clang-15„ÄÅLLD ÂèäÁõ∏ÂÖ≥‰æùËµñ
          sudo apt-get -y install \
            clang-15 lld-15 clang-tools-15 \
            libclang-15-dev llvm-15-dev \
            libc++-dev libc++abi-dev \
            cmake ninja-build libssl-dev gperf xz-utils \
            libgl1-mesa-dev libglu1-mesa-dev libegl1-mesa-dev \
            libx11-dev libxext-dev libxcb1-dev \
            protobuf-compiler libprotobuf-dev
          echo "üîç Â∑•ÂÖ∑‰ΩçÁΩÆÔºö"
          for tool in clang-15 clang++-15 ld.lld cmake ninja openssl protoc; do
            which $tool || echo "$tool Êú™ÊâæÂà∞"
          done
          # ËÆæÁΩÆÈªòËÆ§ clang / clang++ ÊåáÂêëÁâàÊú¨ 15
          sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 600
          sudo update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-15 600
          # È™åËØÅ
          clang --version
          clang++ --version

      - name: Download & extract Qt
        if: steps.cache-qt-source.outputs.cache-hit != 'true'
        run: |
          ARCHIVE="$RUNNER_TEMP/qt6.tar.xz"
          TARGET_DIR="$RUNNER_TEMP/qt6_src"
          echo "üì¶ Downloading Qt source archive..."
          curl -L -o "$ARCHIVE" "$QT_SOURCE_URL"
          echo "üìÇ Extracting .tar.xz via tar..."
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          tar -xJf "$ARCHIVE" -C "$TARGET_DIR"
          echo "‚úÖ Extraction complete: $TARGET_DIR"

      - name: Configure & build & install Release
        env:
          CONFIG: Release
          CC: clang
          CXX: clang++
          LD: ld.lld
        run: |
          SRC_QT="$RUNNER_TEMP/qt6_src/qt-everywhere-src-$QT_VERSION"
          BUILD_DIR="$RUNNER_TEMP/build-${CONFIG}"
          INSTALL_DIR="$RUNNER_TEMP/qt-$QT_VERSION/$CONFIG"
          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"

          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          mkdir -p "$INSTALL_DIR" "$ARTIFACTS_DIR"

          if [[ "$CONFIG" == "Debug" ]]; then
            MODE="-debug"
          elif [[ "$CONFIG" == "Release" ]]; then
            MODE="-release"
          else
            MODE="-release -force-debug-info"
          fi

          "$SRC_QT/configure" \
            -static -static-runtime $MODE \
            -optimize-size -gc-binaries -ltcg -reduce-exports \
            -prefix "$INSTALL_DIR" -no-pch \
            -nomake examples -nomake tests -skip qtwebengine \
            -opensource -confirm-license \
            -qt-libpng -qt-libjpeg -qt-zlib -qt-pcre -qt-freetype \
            -no-sql-psql -no-zstd \
            -- \
              -Wno-dev \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++ \
              -DCMAKE_CXX_FLAGS="-Os -ffunction-sections -fdata-sections" \
              -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections"

          cmake --build . --parallel 2
          cmake --install .

          # Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩï
          echo "üßπ Cleaning up build directory..."
          rm -rf "$BUILD_DIR"
          echo "‚úÖ Build directory cleaned."

      - name: Package Release as tar.gz
        env:
          CONFIG: Release
        run: |
          set -euo pipefail

          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"
          mkdir -p "$ARTIFACTS_DIR"

          BASE="qt-${QT_VERSION}-static-linux-clang15_x64-${CONFIG}"
          SINGLE="$ARTIFACTS_DIR/$BASE.tar.gz"
          INSTALL_DIR="$RUNNER_TEMP/qt-$QT_VERSION/$CONFIG"
          LIMIT=$((1950 * 1024 * 1024))

          SRC_DIR="$RUNNER_TEMP/qt-${QT_VERSION}"

          echo "üì¶ Trying to create single archive: $SINGLE"
          tar -C "$SRC_DIR" -czf "$SINGLE" "$CONFIG"

          SIZE=$(stat -c%s "$SINGLE")

          echo "üìè Archive size: $((SIZE/1024/1024)) MiB (limit is $((LIMIT/1024/1024)) MiB)"

          if (( SIZE > LIMIT )); then
            echo "‚ö†Ô∏è  Size exceeds limit, regenerating as split volumes‚Ä¶"
            rm -f "$SINGLE"

            # ‰ΩøÁî®ÁÆ°ÈÅìÂéãÁº©Âπ∂ÂàÜÂç∑ÔºåÊØèÂç∑ 1950m
            tar -C "$SRC_DIR" -czf - "$CONFIG" \
              | split -b1950m - "$ARTIFACTS_DIR/$BASE.tar.gz.part-"

            echo "‚úÖ Created split volumes in $ARTIFACTS_DIR:"
            ls -1 "$ARTIFACTS_DIR/$BASE.tar.gz.part-"*
          else
            echo "‚úÖ Created single archive: $SINGLE"
          fi
          echo "üì¶ Packaged artifact: $SINGLE"
          echo "üßπ Clean up install directory: $INSTALL_DIR"
          rm -rf "$INSTALL_DIR"
          echo "‚úÖ Install directory cleaned."
      
      - name: Update package to github artifacts
        uses: actions/upload-artifact@v4
        env:
          QT_VERSION: ${{ env.QT_VERSION }}
          CONFIG: Release
        with:
          name: "qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}"
          path: ${{ runner.temp }}/artifacts/qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*
        
      - name: Clean up tar.gz files
        env:
          QT_VERSION: ${{ env.QT_VERSION }}
          CONFIG: Release
        run: |
          echo "‚úÖ Uploaded artifact: qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*"
          echo "üßπ Clean up tar.gz files"
          rm -f ${{ runner.temp }}/artifacts/qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*
          echo "‚úÖ Clean up complete"

      - name: Configure & build & install Debug
        env:
          CONFIG: Debug
          CC: clang
          CXX: clang++
          LD: ld.lld
        run: |
          SRC_QT="$RUNNER_TEMP/qt6_src/qt-everywhere-src-$QT_VERSION"
          BUILD_DIR="$RUNNER_TEMP/build-${CONFIG}"
          INSTALL_DIR="$RUNNER_TEMP/qt-$QT_VERSION/$CONFIG"
          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"

          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          mkdir -p "$INSTALL_DIR" "$ARTIFACTS_DIR"

          if [[ "$CONFIG" == "Debug" ]]; then
            MODE="-debug"
          elif [[ "$CONFIG" == "Release" ]]; then
            MODE="-release"
          else
            MODE="-release -force-debug-info"
          fi

          "$SRC_QT/configure" \
            -static -static-runtime $MODE \
            -gc-binaries -ltcg -reduce-exports \
            -prefix "$INSTALL_DIR" -no-pch \
            -nomake examples -nomake tests -skip qtwebengine -skip qt3d \
            -opensource -confirm-license \
            -qt-libpng -qt-libjpeg -qt-zlib -qt-pcre -qt-freetype \
            -no-sql-psql -no-zstd \
            -- \
              -Wno-dev \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++ \
              -DCMAKE_CXX_FLAGS="-ffunction-sections -fdata-sections" \
              -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections"

          cmake --build . --parallel 1
          cmake --install .

          # Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩï
          echo "üßπ Cleaning up build directory..."
          rm -rf "$BUILD_DIR"
          echo "‚úÖ Build directory cleaned."

      - name: Package Debug as tar.gz
        env:
          CONFIG: Debug
        run: |
          set -euo pipefail

          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"
          mkdir -p "$ARTIFACTS_DIR"

          CLANG_FULL=$(clang --version | head -n1 | grep -oP '\d+\.\d+(\.\d+)?' | head -n1)
          CLANG_VER=${CLANG_FULL%%.*}
          echo "Clang version: $CLANG_VER"
          
          BASE="qt-${QT_VERSION}-static-linux-clang${CLANG_VER}_x64-${CONFIG}"
          SINGLE="$ARTIFACTS_DIR/$BASE.tar.gz"
          LIMIT=$((1950 * 1024 * 1024))

          SRC_DIR="$RUNNER_TEMP/qt-${QT_VERSION}"

          echo "üì¶ Trying to create single archive: $SINGLE"
          tar -C "$SRC_DIR" -czf "$SINGLE" "$CONFIG"

          SIZE=$(stat -c%s "$SINGLE")

          echo "üìè Archive size: $((SIZE/1024/1024)) MiB (limit is $((LIMIT/1024/1024)) MiB)"

          if (( SIZE > LIMIT )); then
            echo "‚ö†Ô∏è  Size exceeds limit, regenerating as split volumes‚Ä¶"
            rm -f "$SINGLE"

            # ‰ΩøÁî®ÁÆ°ÈÅìÂéãÁº©Âπ∂ÂàÜÂç∑ÔºåÊØèÂç∑ 1950m
            tar -C "$SRC_DIR" -czf - "$CONFIG" \
              | split -b1950m - "$ARTIFACTS_DIR/$BASE.tar.gz.part-"

            echo "‚úÖ Created split volumes in $ARTIFACTS_DIR:"
            ls -1 "$ARTIFACTS_DIR/$BASE.tar.gz.part-"*
          else
            echo "‚úÖ Created single archive: $SINGLE"
          fi
                    echo "üì¶ Packaged artifact: $SINGLE"
          echo "üßπ Clean up install directory: $INSTALL_DIR"
          rm -rf "$INSTALL_DIR"
          echo "‚úÖ Install directory cleaned."
      
      - name: Update package to github artifacts
        uses: actions/upload-artifact@v4
        env:
          QT_VERSION: ${{ env.QT_VERSION }}
          CONFIG: Debug
        with:
          name: "qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}"
          path: ${{ runner.temp }}/artifacts/qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*
        
      - name: Clean up tar.gz files
        env:
          QT_VERSION: ${{ env.QT_VERSION }}
          CONFIG: Debug
        run: |
          echo "‚úÖ Uploaded artifact: qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*"
          echo "üßπ Clean up tar.gz files"
          rm -f ${{ runner.temp }}/artifacts/qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*
          echo "‚úÖ Clean up complete"

      - name: Configure & build & install RelWithDebInfo
        env:
          CONFIG: RelWithDebInfo
          CC: clang
          CXX: clang++
          LD: ld.lld
        run: |
          SRC_QT="$RUNNER_TEMP/qt6_src/qt-everywhere-src-$QT_VERSION"
          BUILD_DIR="$RUNNER_TEMP/build-${CONFIG}"
          INSTALL_DIR="$RUNNER_TEMP/qt-$QT_VERSION/$CONFIG"
          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"

          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          mkdir -p "$INSTALL_DIR" "$ARTIFACTS_DIR"

          if [[ "$CONFIG" == "Debug" ]]; then
            MODE="-debug"
          elif [[ "$CONFIG" == "Release" ]]; then
            MODE="-release"
          else
            MODE="-release -force-debug-info"
          fi

          "$SRC_QT/configure" \
            -static -static-runtime $MODE \
            -gc-binaries -ltcg -reduce-exports \
            -prefix "$INSTALL_DIR" -no-pch \
            -nomake examples -nomake tests -skip qtwebengine -skip qt3d \
            -opensource -confirm-license \
            -qt-libpng -qt-libjpeg -qt-zlib -qt-pcre -qt-freetype \
            -no-sql-psql -no-zstd \
            -- \
              -Wno-dev \
              -DCMAKE_C_COMPILER=clang \
              -DCMAKE_CXX_COMPILER=clang++ \
              -DCMAKE_CXX_FLAGS="-ffunction-sections -fdata-sections" \
              -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections"

          cmake --build . --parallel 1
          cmake --install .

          # Ê∏ÖÁêÜÊûÑÂª∫ÁõÆÂΩï
          echo "üßπ Cleaning up build directory..."
          rm -rf "$BUILD_DIR"
          echo "‚úÖ Build directory cleaned."

      - name: Package RelWithDebInfo as tar.gz
        env:
          CONFIG: RelWithDebInfo
        run: |
          set -euo pipefail

          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"
          mkdir -p "$ARTIFACTS_DIR"

          CLANG_FULL=$(clang --version | head -n1 | grep -oP '\d+\.\d+(\.\d+)?' | head -n1)
          CLANG_VER=${CLANG_FULL%%.*}
          echo "Clang version: $CLANG_VER"
          
          BASE="qt-${QT_VERSION}-static-linux-clang${CLANG_VER}_x64-${CONFIG}"
          SINGLE="$ARTIFACTS_DIR/$BASE.tar.gz"
          LIMIT=$((1950 * 1024 * 1024))

          SRC_DIR="$RUNNER_TEMP/qt-${QT_VERSION}"

          echo "üì¶ Trying to create single archive: $SINGLE"
          tar -C "$SRC_DIR" -czf "$SINGLE" "$CONFIG"

          SIZE=$(stat -c%s "$SINGLE")

          echo "üìè Archive size: $((SIZE/1024/1024)) MiB (limit is $((LIMIT/1024/1024)) MiB)"

          if (( SIZE > LIMIT )); then
            echo "‚ö†Ô∏è  Size exceeds limit, regenerating as split volumes‚Ä¶"
            rm -f "$SINGLE"

            # ‰ΩøÁî®ÁÆ°ÈÅìÂéãÁº©Âπ∂ÂàÜÂç∑ÔºåÊØèÂç∑ 1950m
            tar -C "$SRC_DIR" -czf - "$CONFIG" \
              | split -b1950m - "$ARTIFACTS_DIR/$BASE.tar.gz.part-"

            echo "‚úÖ Created split volumes in $ARTIFACTS_DIR:"
            ls -1 "$ARTIFACTS_DIR/$BASE.tar.gz.part-"*
          else
            echo "‚úÖ Created single archive: $SINGLE"
          fi
                    echo "üì¶ Packaged artifact: $SINGLE"
          echo "üßπ Clean up install directory: $INSTALL_DIR"
          rm -rf "$INSTALL_DIR"
          echo "‚úÖ Install directory cleaned."
      
      - name: Update package to github artifacts
        uses: actions/upload-artifact@v4
        env:
          QT_VERSION: ${{ env.QT_VERSION }}
          CONFIG: RelWithDebInfo
        with:
          name: "qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}"
          path: ${{ runner.temp }}/artifacts/qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*
        
      - name: Clean up tar.gz files
        env:
          QT_VERSION: ${{ env.QT_VERSION }}
          CONFIG: RelWithDebInfo
        run: |
          echo "‚úÖ Uploaded artifact: qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*"
          echo "üßπ Clean up tar.gz files"
          rm -f ${{ runner.temp }}/artifacts/qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-${{ env.CONFIG }}*.tar.gz*
          echo "‚úÖ Clean up complete"

  update-release:
    name: Update Package File to Release
    runs-on: ubuntu-latest
    needs: build-qt
    permissions:
      contents: write

    env:
      QT_MAJMIN: ${{ inputs.qt_majmin }}
      QT_VERSION: ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}
      TAG: v${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}-static
      GITHUB_REPOSITORY: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Download Release Package from artifact
        uses: actions/download-artifact@v4
        with:
          name: qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-Release
          path: ${{ runner.temp }}/artifacts

      - name: Download Debug Package from artifact
        uses: actions/download-artifact@v4
        with:
          name: qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-Debug
          path: ${{ runner.temp }}/artifacts

      - name: Download RelWithDebInfo Package from artifact
        uses: actions/download-artifact@v4
        with:
          name: qt-${{ env.QT_VERSION }}-static-linux-clang15_x64-RelWithDebInfo
          path: ${{ runner.temp }}/artifacts

      - name: Create Tag if not exists
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
        shell: bash
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO:      ${{ github.repository }}
          TAG:       v${{ env.QT_VERSION }}-static
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Local tag $TAG already exists, skip."
          elif git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "Remote tag $TAG already exists, skip."
          else
            git tag "$TAG"
            git push "https://x-access-token:$PAT_TOKEN@github.com/$REPO" "$TAG"
            echo "Tag $TAG created and pushed."
          fi

      - name: Ensure Release exists or create
        id: ensure_release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ env.QT_VERSION }}-static"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "found=existing" >> $GITHUB_OUTPUT
          else
            echo "found=new" >> $GITHUB_OUTPUT
            gh release create "$TAG" \
              --title "Qt $TAG Auto Builds" \
              --notes "Automated build of Qt $TAG" \
              --draft=false \
              --prerelease=false
          fi

      - name: Upload all build artifacts
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          QT_VERSION: ${{ env.QT_VERSION }}
        run: |
          set -euo pipefail

          CLANG_FULL=$(clang --version | head -n1 | grep -oP '\d+\.\d+(\.\d+)?')
          CLANG_VER=${CLANG_FULL%%.*}
          TAG="v${QT_VERSION}-static"
          ART_DIR="$RUNNER_TEMP/artifacts"

          for CONFIG in Release Debug RelWithDebInfo; do
            BASE="qt-${QT_VERSION}-static-linux-clang${CLANG_VER}_x64-${CONFIG}"
            
            echo "üîç Looking for $BASE* in $ART_DIR"
            matches=( "$ART_DIR"/"$BASE"*.tar.gz* )

            if [[ -e "${matches[0]}" ]]; then
              for file in "${matches[@]}"; do
                echo "üì§ Uploading $(basename "$file") to release $TAG"
                gh release upload "$TAG" "$file" --clobber
              done
            else
              echo "‚ö†Ô∏è No artifacts found for $BASE, skipping."
            fi
          done

          echo "‚úÖ All available artifacts uploaded."