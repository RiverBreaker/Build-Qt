name: Build Qt 6.x.x -shared for macOS (Clang15)

on:
  workflow_dispatch:
    inputs:
      qt_majmin:
        description: 'Qt ‰∏ªÁâàÊú¨Âè∑‰∏éÊ¨°ÁâàÊú¨Âè∑(>=6.7.0)'
        required: true
        default: '6.7'
      qt_patch:
        description: 'Qt Ë°•‰∏ÅÁâàÊú¨Âè∑(‰æãÂ¶Ç 0)'
        required: false
        default: '0'

jobs:
  build-qt:
    name: Build Qt ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }} ‚Äì ${{ matrix.config }} for macOS
    runs-on: macos-latest
    permissions:
      contents: write

    strategy:
      matrix:
        config: [Debug, Release, RelWithDebInfo]
    env:
      MACOSX_VERSION: "14.0"
      LLVM_VERSION: "17"
      QT_MAJMIN: ${{ inputs.qt_majmin }}
      QT_VERSION: ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}
      TAG: v${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}-shared
      GITHUB_REPOSITORY: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      QT_SOURCE_URL: https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/${{ inputs.qt_majmin }}/${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}/single/qt-everywhere-src-${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}.tar.xz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          architecture: 'x64'

      - name: Cache Qt source
        id: cache-qt-source
        uses: actions/cache@v3
        with:
          key: qt-src-${{ env.QT_VERSION }}-Unix
          path: ${{ runner.temp }}/qt6_src

      - name: Install build tools via Homebrew
        shell: bash
        run: |
          echo "üîß Installing build tools via Homebrew..."
          brew update
          for tool in cmake ninja openssl gperf; do
            if brew list --formula "$tool" &>/dev/null; then
              echo "‚ö†Ô∏è  $tool already installed, skipping..."
            else
              echo "üì¶ Installing $tool..."
              brew install "$tool"
            fi
          done
          LLVM_VERSION=${{ env.LLVM_VERSION }}
          if brew list --formula "llvm@${LLVM_VERSION}" &>/dev/null; then
              echo "‚ö†Ô∏è  llvm@${LLVM_VERSION} already installed, skipping..."
            else
              echo "üì¶ Installing llvm@${LLVM_VERSION}..."
              brew install "llvm@${LLVM_VERSION}"
            fi

          echo "üîç Verifying tool locations with priority:"
          for tool in clang clang++ cmake ninja; do
            echo "üìç $(which $tool) ‚Üí $(basename $(dirname $(which $tool)))"
          done

          MACOSX_VERSION=${{ env.MACOSX_VERSION }}

          ls /Library/Developer/CommandLineTools/SDKs/
          echo "/Applications/Xcode_16.4.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/"
          ls /Applications/Xcode_16.4.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
          # ln -s /Library/Developer/CommandLineTools/SDKs/MacOSX14.5.sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
          # ls /Applications/Xcode_16.4.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
          # # download MacOSX14
          SDK_URL="https://github.com/joseluisq/macosx-sdks/releases/download/$MACOSX_VERSION/MacOSX$MACOSX_VERSION.sdk.tar.xz"
          curl -L -o "$RUNNER_TEMP/MacOSX$MACOSX_VERSION.sdk.tar.xz" "$SDK_URL"
          sudo tar -xJf "$RUNNER_TEMP/MacOSX$MACOSX_VERSION.sdk.tar.xz" -C /Library/Developer/CommandLineTools/SDKs/
          ln -s /Library/Developer/CommandLineTools/SDKs/MacOSX$MACOSX_VERSION.sdk /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/
          # ls /Library/Developer/CommandLineTools/SDKs/
          ls /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/

      - name: Download & extract Qt
        if: steps.cache-qt-source.outputs.cache-hit != 'true'
        shell: bash
        run: |
          ARCHIVE="$RUNNER_TEMP/qt6.tar.xz"
          TARGET_DIR="$RUNNER_TEMP/qt6_src"
          echo "üì¶ Downloading Qt source archive..."
          curl -L -o "$ARCHIVE" "$QT_SOURCE_URL"
          echo "üìÇ Extracting .tar.xz via tar..."
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          # -x: extract; -J: .xz; -f: file; -C: target dir
          tar -xJf "$ARCHIVE" -C "$TARGET_DIR"
          echo "‚úÖ Extraction complete: $TARGET_DIR"

      - name: Prepare build directory
        shell: bash
        run: |
          rm -rf "$RUNNER_TEMP/build"
          mkdir -p "$RUNNER_TEMP/build"

      - name: Configure & build & install ${{ matrix.config }}
        shell: bash
        env:
          CONFIG: ${{ matrix.config }}
        run: |
          SRC_QT="$RUNNER_TEMP/qt6_src/qt-everywhere-src-$QT_VERSION"
          BUILD_DIR="$RUNNER_TEMP/build-${CONFIG}"
          INSTALL_DIR="$RUNNER_TEMP/qt-$QT_VERSION/$CONFIG"
          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"
          MACOSX_VERSION=${{ env.MACOSX_VERSION }}
          LLVM_VERSION=${{ env.LLVM_VERSION }}

          xcrun --show-sdk-path --sdk macosx
          xcrun --show-sdk-version --sdk macosx
          # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáèÂº∫Âà∂ SDK ÈÄâÊã©
          export SDKROOT=$(xcrun --sdk macosx$MACOSX_VERSION --show-sdk-path)
          export DEVELOPER_DIR=$(xcode-select -p)  # ‰øùÊåÅÂΩìÂâçÂºÄÂèëËÄÖÁõÆÂΩï

          # È™åËØÅ SDK ÁâàÊú¨
          echo "‰ΩøÁî® SDK ÁâàÊú¨: $(xcrun --sdk macosx$MACOSX_VERSION --show-sdk-version)"

          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          mkdir -p "$INSTALL_DIR"
          mkdir -p "$ARTIFACTS_DIR"

          # ÈÄâÊã©Ê®°Âºè
          if [[ "$CONFIG" == "Debug" ]]; then
            MODE="-debug"
          elif [[ "$CONFIG" == "Release" ]]; then
            MODE="-release"
          else
            MODE="-release -force-debug-info"
          fi

          # Ë∞ÉÁî® configure
          "$SRC_QT/configure" -shared $MODE -prefix "$INSTALL_DIR" \
            -nomake examples -nomake tests -skip qtwebengine -opensource \
            -confirm-license -qt-libpng -qt-libjpeg -qt-zlib -qt-pcre -qt-freetype \
            -no-sql-psql -no-framework -platform macx-clang \
            -- \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=$MACOSX_VERSION \
            -DCMAKE_OSX_SYSROOT="$SDKROOT" \
            -DCMAKE_C_COMPILER=/opt/homebrew/opt/llvm@${LLVM_VERSION}/bin/clang \
            -DCMAKE_CXX_COMPILER=/opt/homebrew/opt/llvm@${LLVM_VERSION}/bin/clang++ \
            -Wno-dev
          # ÊûÑÂª∫Âπ∂ÂÆâË£Ö
          cmake --build . --parallel
          cmake --install .

          # 7. Â§çÂà∂ËÆ∏ÂèØËØÅÊñá‰ª∂
          mkdir -p "$INSTALL_DIR/licenses"
          python "$GITHUB_WORKSPACE/copy_license.py" "$SRC_QT" "$INSTALL_DIR/licenses"

      - name: Package ${{ matrix.config }} as tar.gz
        shell: bash
        env:
          CONFIG: ${{ matrix.config }}
          LLVM_VERSION: ${{ env.LLVM_VERSION }}
        run: |
          mkdir -p "$RUNNER_TEMP/artifacts"
          CLANG_FULL=$(/opt/homebrew/opt/llvm@${LLVM_VERSION}/bin/clang --version | grep -oE 'clang version [0-9]+\.[0-9]+\.[0-9]+' | awk '{print $3}')
          CLANG_VER=$(echo "$CLANG_FULL" | cut -d. -f1)
          echo "üîç Detected Clang: $CLANG_FULL ‚Üí $CLANG_VER"
          ASSET="qt-${QT_VERSION}-shared-mac-clang_${CLANG_VER}_x64-${CONFIG}.tar.gz"
          echo "üì¶ Packaging $CONFIG into $ASSET via tar..."
          # ÂàáÊç¢Âà∞ÂåÖÂê´ CONFIG Â≠êÁõÆÂΩïÁöÑÁà∂ÁõÆÂΩï
          cd "$RUNNER_TEMP/qt-${QT_VERSION}"
          # -c: create, -z: gzip, -f: filename, -C: change dir
          tar -czf "$RUNNER_TEMP/artifacts/$ASSET" -C . "$CONFIG"
          echo "‚úÖ Packaged artifact: $RUNNER_TEMP/artifacts/$ASSET"
