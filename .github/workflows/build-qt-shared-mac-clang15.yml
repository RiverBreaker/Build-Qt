name: Build Qt 6.x.x -shared for macOS (Clang15)

on:
  workflow_dispatch:
    inputs:
      qt_majmin:
        description: 'Qt ä¸»ç‰ˆæœ¬å·ä¸Žæ¬¡ç‰ˆæœ¬å·(>=6.7.0)'
        required: true
        default: '6.9'
      qt_patch:
        description: 'Qt è¡¥ä¸ç‰ˆæœ¬å·(ä¾‹å¦‚ 0)'
        required: false
        default: '0'

jobs:
  build-qt:
    name: Build Qt ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }} â€“ ${{ matrix.config }} for macOS
    runs-on: macos-latest
    permissions:
      contents: write

    strategy:
      matrix:
        config: [Debug, Release, RelWithDebInfo]
    env:
      QT_MAJMIN: ${{ inputs.qt_majmin }}
      QT_VERSION: ${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}
      TAG: v${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}-shared
      GITHUB_REPOSITORY: ${{ github.repository }}
      GH_TOKEN: ${{ github.token }}
      QT_SOURCE_URL: https://mirrors.tuna.tsinghua.edu.cn/qt/archive/qt/${{ inputs.qt_majmin }}/${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}/single/qt-everywhere-src-${{ inputs.qt_majmin }}.${{ inputs.qt_patch }}.tar.xz

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          architecture: 'x64'

      - name: Cache Qt source
        id: cache-qt-source
        uses: actions/cache@v3
        with:
          key: qt-src-${{ env.QT_VERSION }}-Unix
          path: ${{ runner.temp }}/qt6_src

      - name: Install build tools via Homebrew
        shell: bash
        run: |
          echo "ðŸ”§ Installing build tools via Homebrew..."
          brew update
          for tool in cmake ninja openssl gperf; do
            if brew list --formula "$tool" &>/dev/null; then
              echo "âš ï¸  $tool already installed, skipping..."
            else
              echo "ðŸ“¦ Installing $tool..."
              brew install "$tool"
            fi
          done

          echo "âš™ï¸ Installing LLVM 15 (Clang 15)..."
          # æ£€æŸ¥ llvm@15 æ˜¯å¦å¯ç”¨
          if brew formulae | grep -q "llvm@15"; then
            brew install llvm@15
          else
            echo "âŒ llvm@15 not available in Homebrew formulae!"
            echo "ðŸ’¡ Try: brew tap homebrew/cask-versions && brew install llvm@15"
            exit 1
          fi

          # ðŸŒŸ å…³é”®ï¼šè®¾ç½® macOS ä¸“å±žä¼˜å…ˆçº§
          LLVM15_PATH=$(brew --prefix llvm@15)

          # 2. æ°¸ä¹…ç”Ÿæ•ˆï¼ˆä»…é™å½“å‰ç”¨æˆ·ï¼Œç»•è¿‡ SIP é™åˆ¶ï¼‰
          echo "ðŸ’¾ Configuring permanent PATH priority in ~/.zshrc..."
          cat >> ~/.zshrc <<EOF

          # ðŸ”¥ Custom Clang 15 priority settings (added by build script)
          export PATH="$LLVM15_PATH/bin:\$PATH"
          export LDFLAGS="-L$LLVM15_PATH/lib \$LDFLAGS"
          export CPPFLAGS="-I$LLVM15_PATH/include \$CPPFLAGS"
          export SDKROOT=$(xcrun --sdk macosx --show-sdk-path)
          EOF

          # 3. ç«‹å³åŠ è½½æ–°é…ç½®
          source ~/.zshrc

          echo "ðŸ” Verifying tool locations with priority:"
          for tool in clang clang++ cmake ninja; do
            echo "ðŸ“ $(which $tool) â†’ $(basename $(dirname $(which $tool)))"
          done

          echo "âœ… Final Clang version (MUST show 15.x):"
          clang --version

      - name: Download & extract Qt
        if: steps.cache-qt-source.outputs.cache-hit != 'true'
        shell: bash
        run: |
          ARCHIVE="$RUNNER_TEMP/qt6.tar.xz"
          TARGET_DIR="$RUNNER_TEMP/qt6_src"
          echo "ðŸ“¦ Downloading Qt source archive..."
          curl -L -o "$ARCHIVE" "$QT_SOURCE_URL"
          echo "ðŸ“‚ Extracting .tar.xz via tar..."
          rm -rf "$TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          # -x: extract; -J: .xz; -f: file; -C: target dir
          tar -xJf "$ARCHIVE" -C "$TARGET_DIR"
          echo "âœ… Extraction complete: $TARGET_DIR"

      - name: Prepare build directory
        shell: bash
        run: |
          rm -rf "$RUNNER_TEMP/build"
          mkdir -p "$RUNNER_TEMP/build"

      - name: Configure & build & install ${{ matrix.config }}
        shell: bash
        env:
          CONFIG: ${{ matrix.config }}
        run: |
          SRC_QT="$RUNNER_TEMP/qt6_src/qt-everywhere-src-$QT_VERSION"
          BUILD_DIR="$RUNNER_TEMP/build-${CONFIG}"
          INSTALL_DIR="$RUNNER_TEMP/qt-$QT_VERSION/$CONFIG"
          ARTIFACTS_DIR="$RUNNER_TEMP/artifacts"

          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          mkdir -p "$INSTALL_DIR"
          mkdir -p "$ARTIFACTS_DIR"

          # é€‰æ‹©æ¨¡å¼
          if [[ "$CONFIG" == "Debug" ]]; then
            MODE="-debug"
          elif [[ "$CONFIG" == "Release" ]]; then
            MODE="-release"
          else
            MODE="-release -force-debug-info"
          fi

          # è°ƒç”¨ configure
          "$SRC_QT/configure" -shared $MODE -prefix "$INSTALL_DIR" \
            -nomake examples -nomake tests -skip qtwebengine -opensource \
            -confirm-license -qt-libpng -qt-libjpeg -qt-zlib -qt-pcre -qt-freetype \
            -no-sql-psql -no-framework -- \
            -DCMAKE_C_COMPILER="/opt/homebrew/opt/llvm@15/bin/clang" \
            -DCMAKE_CXX_COMPILER="/opt/homebrew/opt/llvm@15/bin/clang++" \
            -DCMAKE_PREFIX_PATH="/opt/homebrew/opt/llvm@15" \
            -Wno-dev
          # æž„å»ºå¹¶å®‰è£…
          cmake --build . --parallel
          cmake --install .

          rem 7. å¤åˆ¶è®¸å¯è¯æ–‡ä»¶
          mkdir -p "%INSTALL_DIR%\licenses"
          python "%GITHUB_WORKSPACE%/copy_license.py" "%SRC_QT%" "%INSTALL_DIR%\licenses"

      - name: Package ${{ matrix.config }} as tar.gz
        shell: bash
        env:
          CONFIG: ${{ matrix.config }}
        run: |
          mkdir -p "$RUNNER_TEMP/artifacts"
          CLANG_FULL=$(clang --version | grep -oE 'clang version [0-9]+\.[0-9]+\.[0-9]+' | awk '{print $3}')
          CLANG_VER=$(echo "$CLANG_FULL" | cut -d. -f1)
          echo "ðŸ” Detected Clang: $CLANG_FULL â†’ $CLANG_VER"
          ASSET="qt-${QT_VERSION}-shared-mac-clang_${CLANG_VER}_x64-${CONFIG}.tar.gz"
          echo "ðŸ“¦ Packaging $CONFIG into $ASSET via tar..."
          # åˆ‡æ¢åˆ°åŒ…å« CONFIG å­ç›®å½•çš„çˆ¶ç›®å½•
          cd "$RUNNER_TEMP/qt-${QT_VERSION}"
          # -c: create, -z: gzip, -f: filename, -C: change dir
          tar -czf "$RUNNER_TEMP/artifacts/$ASSET" -C . "$CONFIG"
          echo "âœ… Packaged artifact: $RUNNER_TEMP/artifacts/$ASSET"


      - name: Create Tag if not exists
        if: github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'
        shell: bash
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          REPO:      ${{ github.repository }}
          TAG:       v${{ env.QT_VERSION }}-shared
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # æ£€æŸ¥ TAG æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Local tag $TAG already exists, skip."
          elif git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
            echo "Remote tag $TAG already exists, skip."
          else
            git tag "$TAG"
            git push "https://x-access-token:$PAT_TOKEN@github.com/$REPO" "$TAG"
            echo "Tag $TAG created and pushed."
          fi

      - name: Ensure Release exists or create
        id: ensure_release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="v${{ env.QT_VERSION }}-shared"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "found=existing" >> $GITHUB_OUTPUT
          else
            echo "found=new" >> $GITHUB_OUTPUT
            gh release create "$TAG" \
              --title "Qt $TAG Auto Builds" \
              --notes "Automated build of Qt $TAG" \
              --draft=false \
              --prerelease=false
          fi

      - name: Upload build artifacts
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          CLANG_FULL=$(clang --version | grep -oE 'clang version [0-9]+\.[0-9]+\.[0-9]+' | awk '{print $3}')
          CLANG_VER=$(echo "$CLANG_FULL" | cut -d. -f1)
          TAG="v${{ env.QT_VERSION }}-shared"
          ASSET="qt-${QT_VERSION}-shared-mac-clang_${CLANG_VER}_x64-${{ matrix.config }}.tar.gz"
          FILE="$RUNNER_TEMP/artifacts/$ASSET"
          if [ -f "$FILE" ]; then
            gh release upload "$TAG" "$FILE" --clobber
          else
            echo "æ–‡ä»¶æœªæ‰¾åˆ°ï¼Œè·³è¿‡ä¸Šä¼ ï¼š$FILE"
          fi
