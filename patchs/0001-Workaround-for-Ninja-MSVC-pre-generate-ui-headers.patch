From 3c7353e311d156cfba245f892e509a92d2ad0d09 Mon Sep 17 00:00:00 2001
From: RiverBreaker <lyq203q@163.com>
Date: Wed, 17 Sep 2025 20:45:43 +0800
Subject: [PATCH] Workaround for Ninja+MSVC pre-generate ui headers

---
 src/designer/src/lib/CMakeLists.txt | 46 +++++++++++++++++++++++++++++
 1 file changed, 46 insertions(+)

diff --git a/src/designer/src/lib/CMakeLists.txt b/src/designer/src/lib/CMakeLists.txt
index 20335e0dd..13689d246 100644
--- a/src/designer/src/lib/CMakeLists.txt
+++ b/src/designer/src/lib/CMakeLists.txt
@@ -179,7 +179,53 @@ qt_internal_add_module(Designer
     PRECOMPILED_HEADER
         "lib_pch.h"
 )
+# Workaround for Ninja+MSVC: pre-generate ui_*.h so Designer_autogen has the files.
+# This avoids "missing and no known rule to make it" errors when automoc/autouic
+# doesn't create the auto-generated headers early enough for Ninja+MSVC.
+if (MSVC AND CMAKE_GENERATOR MATCHES "Ninja")
+    # base of the .ui files (relative to this CMakeLists)
+    set(UIC_BASE_DIR "${CMAKE_CURRENT_SOURCE_DIR}/shared")

+    # find all .ui files under shared/templates/forms
+    file(GLOB_RECURSE UI_FILES "${UIC_BASE_DIR}/templates/forms/*.ui")
+    set(PREGENERATED_UIC_FILES "")
+
+    foreach(ui ${UI_FILES})
+        # relative path relative to shared (e.g. templates/forms/240x320/Dialog.ui)
+        file(RELATIVE_PATH rel_to_shared "${UIC_BASE_DIR}" "${ui}")
+        get_filename_component(fn ${rel_to_shared} NAME_WE)
+        get_filename_component(rel_dir ${rel_to_shared} DIRECTORY)
+
+        set(out "${CMAKE_CURRENT_BINARY_DIR}/Designer_autogen/include_${CMAKE_BUILD_TYPE}/shared/${rel_dir}/${fn}.h")
+
+        # ensure output directory exists
+        file(MAKE_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}/Designer_autogen/include_${CMAKE_BUILD_TYPE}/shared/${rel_dir}")
+
+        add_custom_command(
+            OUTPUT ${out}
+            COMMAND "$<TARGET_FILE:uic>" "${ui}" -o "${out}"
+            DEPENDS "${ui}"
+            COMMENT "Pre-generating ${out} from ${ui}"
+            VERBATIM
+        )
+
+        list(APPEND PREGENERATED_UIC_FILES ${out})
+    endforeach()
+
+    if (PREGENERATED_UIC_FILES)
+        add_custom_target(Designer_pregenerate_uic DEPENDS ${PREGENERATED_UIC_FILES})
+        # ensure Designer builds after pregeneration
+        add_dependencies(Designer Designer_pregenerate_uic)
+    endif()
+endif()
 # Resources:
 set_source_files_properties("../../../shared/deviceskin/skins/ClamshellPhone.skin"
     PROPERTIES QT_RESOURCE_ALIAS "ClamshellPhone.skin"
--
2.50.1.windows.1
